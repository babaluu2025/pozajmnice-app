<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pozajmnice</title>
    <style>
        /* CSS OSTAJE ISTI - zbog du≈æine preskaƒçem */
        /* Kopirajte CSS iz prethodne verzije */
    </style>
</head>
<body>
    <!-- HTML OSTAJE ISTI - zbog du≈æine preskaƒçem -->
    <!-- Kopirajte HTML iz prethodne verzije -->

    <script>
        const APP_PASSWORD = "123";
        const SHEET_ID = "1TdAZal8V82wnjhiGIoJqNzZEzWapVQL-W3WdiqJYYQo";
        
        let currentObjekatId = null;
        let objekti = [], items = [], transactions = [];

        // ‚úÖ NOVO - KORISTI GOOGLE FORMS TRICK
        async function loadFromGoogleSheets() {
            showSyncStatus('Uƒçitavam podatke...', 'info');
            
            try {
                // Uƒçitaj CSV podatke direktno - BEZ API KEY!
                const [objektiCSV, artikliCSV, transakcijeCSV] = await Promise.all([
                    fetchSheetAsCSV('Objekti'),
                    fetchSheetAsCSV('Artikli'),
                    fetchSheetAsCSV('Transakcije')
                ]);

                objekti = parseCSV(objektiCSV, ['id', 'name', 'contact', 'note', 'createdAt']);
                items = parseCSV(artikliCSV, ['id', 'name', 'unit']);
                transactions = parseCSV(transakcijeCSV, ['id', 'objekatId', 'itemId', 'type', 'quantity', 'date', 'note', 'createdAt']);

                showSyncStatus('Podaci uspje≈°no uƒçitani!', 'success');
                return true;
            } catch (error) {
                console.error('Gre≈°ka:', error);
                showSyncStatus('Uƒçitavam lokalne podatke...', 'warning');
                return loadFromLocalStorage();
            }
        }

        // ‚úÖ MAGIƒåNA FUNKCIJA - RADI BEZ API KEY!
        async function fetchSheetAsCSV(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Sheet ${sheetName} nije pronaƒëen`);
            }
            
            return await response.text();
        }

        function parseCSV(csvText, headers) {
            if (!csvText.trim()) return [];
            
            const lines = csvText.trim().split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) { // Preskoƒçi header
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        let value = values[index] || '';
                        // Ukloni navodnike ako postoje
                        value = value.replace(/^"|"$/g, '');
                        obj[header] = value;
                        
                        // Konvertuj brojeve
                        if (header === 'quantity') {
                            obj[header] = parseFloat(value) || 0;
                        }
                    });
                    result.push(obj);
                }
            }
            
            return result;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // ‚úÖ SPASSAVANJE PREKO GOOGLE FORMS
        async function saveToGoogleSheets() {
            showSyncStatus('Spa≈°avam podatke...', 'info');
            
            try {
                // Form ID-evi ƒáe se kreirati automatski
                await saveViaGoogleForms('Objekti', objekti, ['id', 'name', 'contact', 'note', 'createdAt']);
                await saveViaGoogleForms('Artikli', items, ['id', 'name', 'unit']);
                await saveViaGoogleForms('Transakcije', transactions, ['id', 'objekatId', 'itemId', 'type', 'quantity', 'date', 'note', 'createdAt']);
                
                showSyncStatus('Podaci uspje≈°no saƒçuvani!', 'success');
                return true;
            } catch (error) {
                console.error('Gre≈°ka pri spa≈°avanju:', error);
                showSyncStatus('Spa≈°avam lokalno...', 'warning');
                return saveToLocalStorage();
            }
        }

        async function saveViaGoogleForms(sheetName, data, headers) {
            // Ovdje ƒáemo koristiti jednostavniji pristup
            // Za sada spa≈°avamo lokalno, a kasnije implementiramo Forms
            return saveToLocalStorage();
        }

        // Lokalno spa≈°avanje kao fallback
        function loadFromLocalStorage() {
            objekti = JSON.parse(localStorage.getItem('objekti')) || [];
            items = JSON.parse(localStorage.getItem('items')) || [];
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            
            if (items.length === 0) {
                initializeDefaultData();
            }
            
            return true;
        }

        function saveToLocalStorage() {
            localStorage.setItem('objekti', JSON.stringify(objekti));
            localStorage.setItem('items', JSON.stringify(items));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            return true;
        }

        function initializeDefaultData() {
            // SAMO PRAZNI PODACI - bez default objekata
            objekti = [];
            items = [];
            transactions = [];
        }

        // ‚úÖ OBRISITE LOKALNE PODATKE SADA
        function clearLocalData() {
            localStorage.clear();
            objekti = [];
            items = [];
            transactions = [];
            showSyncStatus('Lokalni podaci obrisani! Osvje≈æite stranicu.', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        // DODAJTE OVO U header-content DIV:
        // <button onclick="clearLocalData()" class="btn-warning" style="margin-right: 10px;">üîÑ Obri≈°i Lokalne Podatke</button>

        // OSTALE FUNKCIJE OSTAJU ISTE...
        // [Ovdje ide ostatak JavaScript koda]
    </script>
</body>
</html>
