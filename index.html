<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pozajmnice Auto Sync</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
h1 { color: #333; }
.tab-buttons { margin-bottom: 10px; }
.tab-buttons button { padding: 6px 12px; margin-right: 5px; cursor: pointer; }
.tab-content { display: none; }
.tab-content.active { display: block; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
button.save { margin-top: 10px; }
#status { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h1>Pozajmnice Auto Sync</h1>
<div class="tab-buttons">
    <button data-tab="objekti" class="active">Objekti</button>
    <button data-tab="items">Artikli</button>
    <button data-tab="transactions">Transakcije</button>
</div>

<div id="status">UÄitavam podatke...</div>

<!-- Sekcija Objekti -->
<div id="objekti" class="tab-content active">
    <table>
        <thead><tr><th>Naziv</th><th>Kontakt</th><th>Napomena</th></tr></thead>
        <tbody></tbody>
    </table>
    <button class="save">ğŸ’¾ Spremi Objekte</button>
</div>

<!-- Sekcija Artikli -->
<div id="items" class="tab-content">
    <table>
        <thead><tr><th>Naziv</th><th>Jedinica</th></tr></thead>
        <tbody></tbody>
    </table>
    <button class="save">ğŸ’¾ Spremi Artikle</button>
</div>

<!-- Sekcija Transakcije -->
<div id="transactions" class="tab-content">
    <table>
        <thead><tr><th>Datum</th><th>Objekat</th><th>Artikal</th><th>Tip</th><th>KoliÄina</th><th>Napomena</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw25zcOAYw3z8F_kNFxKIcO-6etdxKlVQF2LkBHCiI/dev';

let objekti = [], items = [], transactions = [];

// Tab navigacija
document.querySelectorAll('.tab-buttons button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-buttons button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

// Fetch podataka
async function loadData() {
    document.getElementById('status').textContent = 'ğŸ”„ UÄitavam podatke...';
    try {
        const [objRes, itemsRes, transRes] = await Promise.all([
            fetch(`${SCRIPT_URL}?sheet=Objekti`),
            fetch(`${SCRIPT_URL}?sheet=Artikli`),
            fetch(`${SCRIPT_URL}?sheet=Transakcije`)
        ]);
        if(!objRes.ok || !itemsRes.ok || !transRes.ok) throw new Error('Fetch failed');

        objekti = await objRes.json();
        items = await itemsRes.json();
        transactions = await transRes.json();

        renderObjekti();
        renderItems();
        renderTransactions();

        document.getElementById('status').textContent = 'âœ… Podaci uÄitani';
    } catch(e) {
        console.error(e);
        document.getElementById('status').textContent = 'âŒ GreÅ¡ka pri uÄitavanju podataka';
    }
}

// Render funkcije
function renderObjekti() {
    const tbody = document.querySelector('#objekti tbody');
    tbody.innerHTML = '';
    objekti.forEach((o,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td contenteditable="true" data-index="${i}" data-field="name">${o.name||''}</td>
            <td contenteditable="true" data-index="${i}" data-field="contact">${o.contact||''}</td>
            <td contenteditable="true" data-index="${i}" data-field="note">${o.note||''}</td>
        `;
        tbody.appendChild(tr);
    });
    tbody.querySelectorAll('td[contenteditable]').forEach(td=>{
        td.addEventListener('input', e=>{
            const index = td.dataset.index;
            const field = td.dataset.field;
            objekti[index][field] = td.textContent;
        });
    });
}

function renderItems() {
    const tbody = document.querySelector('#items tbody');
    tbody.innerHTML = '';
    items.forEach((i,index)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td contenteditable="true" data-index="${index}" data-field="name">${i.name||''}</td>
            <td contenteditable="true" data-index="${index}" data-field="unit">${i.unit||''}</td>
        `;
        tbody.appendChild(tr);
    });
    tbody.querySelectorAll('td[contenteditable]').forEach(td=>{
        td.addEventListener('input', e=>{
            const index = td.dataset.index;
            const field = td.dataset.field;
            items[index][field] = td.textContent;
        });
    });
}

function renderTransactions() {
    const tbody = document.querySelector('#transactions tbody');
    tbody.innerHTML = '';
    transactions.forEach(t=>{
        const objName = objekti.find(o=>o.name===t.objekatId)?.name || t.objekatId || 'Nepoznato';
        const itemName = items.find(i=>i.name===t.itemId)?.name || t.itemId || 'Nepoznato';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.date||''}</td>
            <td>${objName}</td>
            <td>${itemName}</td>
            <td>${t.type||''}</td>
            <td>${t.quantity||''}</td>
            <td>${t.note||''}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Save funkcija
async function saveData(sheetName, data) {
    document.getElementById('status').textContent = `ğŸ’¾ Spremam ${sheetName}...`;
    try {
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({sheet: sheetName, data}),
            headers: {'Content-Type': 'application/json'}
        });
        const result = await res.json();
        if(result.success) document.getElementById('status').textContent = `âœ… ${sheetName} spremljeno`;
        else throw new Error('Save failed');
    } catch(e) {
        console.error(e);
        document.getElementById('status').textContent = `âŒ GreÅ¡ka pri spremanju ${sheetName}`;
    }
}

// Button event
document.querySelectorAll('button.save').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        if(btn.parentElement.id==='objekti') saveData('Objekti', objekti);
        else if(btn.parentElement.id==='items') saveData('Artikli', items);
    });
});

// Auto-save on unload
window.addEventListener('beforeunload', ()=>{
    saveData('Objekti', objekti);
    saveData('Artikli', items);
});

// Pokreni uÄitavanje
loadData();
</script>
</body>
</html>
