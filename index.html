<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<title>Pozajmnice Auto Sync</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
h1 { color: #333; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background: white; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background: #f0f0f0; }
#status { margin-bottom: 20px; font-weight: bold; }
</style>
</head>
<body>
<h1>Pozajmnice Auto Sync</h1>
<div id="status">Učitavanje podataka...</div>

<h2>Objekti</h2>
<table id="objektiTable">
<thead><tr><th>Naziv</th><th>Kontakt</th><th>Napomena</th></tr></thead>
<tbody></tbody>
</table>

<h2>Artikli</h2>
<table id="itemsTable">
<thead><tr><th>Naziv</th><th>Jedinica</th></tr></thead>
<tbody></tbody>
</table>

<h2>Transakcije</h2>
<table id="transactionsTable">
<thead><tr><th>Datum</th><th>Objekat</th><th>Artikal</th><th>Tip</th><th>Količina</th><th>Napomena</th></tr></thead>
<tbody></tbody>
</table>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyPG0r25ZJL2PxENEuMl4tKOWkX_ezz-X6AHdtsm5WT8xM/exec";

let objekti = [], items = [], transactions = [];

// Učitaj sve sheet-ove
async function loadAllSheets() {
    try {
        [objekti, items, transactions] = await Promise.all([
            fetchSheet("Objekti"),
            fetchSheet("Artikli"),
            fetchSheet("Transakcije")
        ]);
        renderAllTables();
        document.getElementById('status').innerText = "Podaci učitani!";
    } catch(err) {
        document.getElementById('status').innerText = "Greška pri učitavanju podataka: " + err;
        console.error(err);
    }
}

// Fetch funkcija za jedan sheet
async function fetchSheet(sheetName) {
    const res = await fetch(SCRIPT_URL + '?sheet=' + sheetName);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    return data;
}

// Render svih tabela
function renderAllTables() {
    renderTable(objekti, "#objektiTable", ["Naziv", "Kontakt", "Napomena"]);
    renderTable(items, "#itemsTable", ["Naziv", "Jedinica"]);
    renderTransactions();
}

function renderTable(data, selector, columns) {
    const tbody = document.querySelector(selector + " tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = columns.map(col => `<td>${row[col] || row[col.toLowerCase()] || ""}</td>`).join("");
        tbody.appendChild(tr);
    });
}

// Posebno za transakcije jer trebamo imena objekta i artikla
function renderTransactions() {
    const tbody = document.querySelector("#transactionsTable tbody");
    tbody.innerHTML = "";
    transactions.forEach(t => {
        const objekat = objekti.find(o => o.Naziv === t.Objekat || o.name === t.objekatId) || {Naziv:"Nepoznato"};
        const item = items.find(i => i.Naziv === t.Artikal || i.name === t.itemId) || {Naziv:"Nepoznato"};
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${t.Datum || t.date || ""}</td>
            <td>${objekat.Naziv}</td>
            <td>${item.Naziv}</td>
            <td>${t.Tip || t.type || ""}</td>
            <td>${t.Količina || t.quantity || ""}</td>
            <td>${t.Napomena || t.note || ""}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Spremi sve sheet-ove
async function saveAllSheets() {
    try {
        await Promise.all([
            saveSheet("Objekti", objekti),
            saveSheet("Artikli", items),
            saveSheet("Transakcije", transactions)
        ]);
        console.log("Podaci spremljeni na Sheet.");
    } catch(err) {
        console.error("Greška pri spremanju:", err);
    }
}

// POST funkcija za sheet
async function saveSheet(sheetName, data) {
    await fetch(SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({sheet: sheetName, data})
    });
}

// Auto učitavanje
window.addEventListener('load', loadAllSheets);
// Auto spremanje prije zatvaranja
window.addEventListener('beforeunload', saveAllSheets);
</script>
</body>
</html>
